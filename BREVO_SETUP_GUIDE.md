# Brevo (Sendinblue) Double Opt-In Setup Guide

This guide explains how to configure Brevo for double opt-in newsletter subscriptions on your Vercel-hosted site.

## Overview

The newsletter form uses Brevo's double opt-in feature, which means:
1. User submits the newsletter form
2. Brevo sends a confirmation email
3. User clicks the confirmation link
4. User is added to your mailing list

## Prerequisites

- Brevo account (free tier available at [brevo.com](https://www.brevo.com))
- Vercel account with deployed site
- Access to Vercel environment variables

## Step 1: Create a Brevo Account

1. Sign up at [brevo.com](https://www.brevo.com)
2. Verify your email address
3. Complete account setup

## Step 2: Get Your Brevo API Key

1. Log in to your Brevo account
2. Go to **Settings** → **API Keys** (or **SMTP & API** → **API Keys**)
3. Click **Generate a new API key**
4. Give it a name (e.g., "Website Newsletter")
5. Copy the API key (you'll only see it once!)

## Step 3: Create a Contact List

1. In Brevo, go to **Contacts** → **Lists**
2. Click **Create a list**
3. Name it (e.g., "Newsletter Subscribers")
4. Copy the **List ID** (you'll see it in the list details or URL)

## Step 4: Enable Double Opt-In

1. In Brevo, go to **Settings** → **SMTP & API** → **SMTP**
2. Scroll to **Double opt-in** section
3. Enable **Double opt-in for contacts**
4. Set the **Confirmation redirect URL** to: `https://yourdomain.com/newsletter-confirmed.html`
   - This is where users will be redirected after clicking the confirmation link
   - Replace `yourdomain.com` with your actual domain
5. (Optional) Customize the confirmation email template:
   - Go to **Campaigns** → **Email Templates**
   - Find the **Double opt-in** template
   - Edit to match your brand
   - The confirmation link is automatically generated by Brevo

## Step 5: Configure Vercel Environment Variables

1. Go to your Vercel project dashboard
2. Navigate to **Settings** → **Environment Variables**
3. Add the following variables:

### Required Variables

| Variable Name | Description | Example |
|--------------|-------------|---------|
| `BREVO_API_KEY` | Your Brevo API key | `xkeysib-abc123...` |
| `BREVO_LIST_ID` | Your Brevo contact list ID | `5` |
| `SITE_URL` | Your site URL (optional, auto-detected) | `https://yourdomain.com` |

### Adding Variables

1. Click **Add New**
2. Enter the variable name (e.g., `BREVO_API_KEY`)
3. Enter the value
4. Select environments: **Production**, **Preview**, and **Development**
5. Click **Save**
6. Repeat for all three variables

## Step 6: Deploy to Vercel

After adding environment variables:

1. Go to **Deployments** tab
2. Click **Redeploy** on your latest deployment
3. Or push a new commit to trigger a deployment

**Note:** Environment variables are only available after deployment. Make sure to redeploy after adding them.

## Step 7: Test the Integration

1. Go to your live site
2. Fill out the newsletter form
3. Submit the form
4. Check your email for the confirmation message
5. Click the confirmation link
6. Verify you're redirected to the confirmation page
7. Check Brevo dashboard to confirm the contact was added

## Troubleshooting

### Form submission fails

- **Check API key:** Verify `BREVO_API_KEY` is correct in Vercel
- **Check list ID:** Verify `BREVO_LIST_ID` matches your list ID
- **Check Vercel logs:** Go to **Deployments** → **Functions** → View logs
- **Check browser console:** Look for JavaScript errors

### Confirmation email not received

- **Check spam folder**
- **Verify email address** in Brevo settings
- **Check Brevo dashboard** → **Contacts** → See if contact is in "Pending" status
- **Verify double opt-in is enabled** in Brevo settings

### Contact not added after confirmation

- **Check Brevo logs:** Go to **Settings** → **Logs**
- **Verify confirmation link:** Should point to `/api/newsletter/confirm`
- **Check list ID:** Make sure it's correct

### API errors in Vercel logs

Common error codes:
- **401 Unauthorized:** Invalid API key
- **400 Bad Request:** Invalid list ID or contact data
- **429 Too Many Requests:** Rate limit exceeded (free tier: 300 emails/day)

## Customizing the Confirmation Email

1. In Brevo, go to **Campaigns** → **Email Templates**
2. Find the **Double opt-in** template
3. Edit the template to match your brand
4. The confirmation link should be: `{{ params.confirm_url }}` or similar (Brevo handles this automatically)

## Contact Attributes

The integration automatically saves these attributes in Brevo:
- `FIRSTNAME` - First name from form
- `LASTNAME` - Last name (if provided)
- `GOAL` - User's ADHD challenge (from textarea)
- `SIGNUP_DATE` - Timestamp of signup
- `SOURCE` - "Website Newsletter Form"

You can use these in your email campaigns for personalization.

## Security Notes

- **Never commit API keys** to Git
- **Use environment variables** for all sensitive data
- **Restrict API key permissions** in Brevo if possible
- **Monitor API usage** in Brevo dashboard

## Support

- **Brevo Documentation:** [help.brevo.com](https://help.brevo.com)
- **Brevo API Docs:** [developers.brevo.com](https://developers.brevo.com)
- **Vercel Docs:** [vercel.com/docs](https://vercel.com/docs)

---

*Last updated: 2025*

